const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),effectCanvas=document.getElementById("effectCanvas"),effectCtx=effectCanvas.getContext("2d");effectCanvas.width=canvas.width,effectCanvas.height=canvas.height,document.body.appendChild(effectCanvas),canvas.width=window.innerWidth,canvas.height=window.innerHeight,effectCanvas.width=window.innerWidth,effectCanvas.height=window.innerHeight;const gameFieldWidth=5*window.innerWidth,gameFieldHeight=5*window.innerHeight,pointsDensity=4e-4,repulsionStrength=5e3,repulsionRadius=10,spaceBuffer=10,bearMargin=400,rotationMultiplier=1;export const sprites=[{t:"./images/tree1.png",v:3,scale:.5},{t:"./images/tree2.png",v:3,scale:.5},{t:"./images/bush1.png",v:11,scale:.2},{t:"./images/bush2.png",v:11,scale:.2},{t:"./images/bush3.png",v:11,scale:.2},{t:"./images/bush4.png",v:11,scale:.2},{t:"./images/peen.png",v:1,scale:.12},{t:"./images/bear.png",v:.3,scale:.1,o:!0}];const canvasState={i:[],points:[],offsetX:0,offsetY:0,S:!1,m:0,u:0,velocityX:0,velocityY:0,l:.9,messages:[],h:[]};function generatePoints(){const a=gameFieldWidth*gameFieldHeight,t=Math.floor(a*pointsDensity),e=canvasState.i.reduce(((a,t)=>a+t.v),0);for(let a=0;a<t;a++){let a=Math.random()*e,t=0;for(let e of canvasState.i)if(t+=e.v,a<t){let a,t,n,s;if(e.o){e.p.width,e.scale,e.p.height,e.scale;a=canvas.width/2,t=gameFieldWidth-canvas.width/2,n=canvas.height/2,s=gameFieldHeight-canvas.height/2}else a=0,t=gameFieldWidth,n=0,s=gameFieldHeight;const c={x:Math.random()*(t-a)+a,y:Math.random()*(s-n)+n,M:e,F:Math.random()<.5,rotationAngle:0,P:e.o?(.02*Math.random()-.01)*rotationMultiplier:0,R:0,B:!1,C:1,W:1,k:!1};canvasState.points.push(c);break}}canvasState.points=canvasState.points.filter(((a,t,e)=>!a.M.o||!e.some(((e,n)=>{if(t===n||!e.M.o)return!1;return Math.hypot(a.x-e.x,a.y-e.y)<a.M.p.width*a.M.scale*2}))));canvasState.points=canvasState.points.filter(((a,t,e)=>!!a.M.o||!e.some((t=>{if(!t.M.o)return!1;const e=t.M.p.width*t.M.scale,n=t.M.p.height*t.M.scale,s=a.M.p.width*a.M.scale,c=a.M.p.height*a.M.scale;return Math.max(0,Math.min(t.x+e/2,a.x+s/2)-Math.max(t.x-e/2,a.x-s/2))*Math.max(0,Math.min(t.y+n/2,a.y+c/2)-Math.max(t.y-n/2,a.y-c/2))>.7*(e*n)})))),console.log("Bears: ",canvasState.points.filter((a=>a.M.o)))}function drawRomb(a,t,e,n,s){ctx.fillStyle=s,ctx.beginPath(),ctx.moveTo(a,t-n/2),ctx.lineTo(a+e/2,t),ctx.lineTo(a,t+n/2),ctx.lineTo(a-e/2,t),ctx.closePath(),ctx.fill()}function drawIsometricBackground(){const a=80,t=40,e=["#77dd77","#99e699"];for(let n=-40;n<canvas.height+t;n+=t)for(let s=-80;s<canvas.width+a;s+=a){drawRomb(s-canvasState.offsetX%a,n-canvasState.offsetY%t,a,t,e[(Math.floor((s+canvasState.offsetX)/a)+Math.floor((n+canvasState.offsetY)/t))%2])}}function render(){ctx.clearRect(0,0,canvas.width,canvas.height),drawIsometricBackground();const a=canvas.width/2+canvasState.offsetX,t=canvas.height/2+canvasState.offsetY;canvasState.points.sort(((a,t)=>a.y+a.M.p.height*a.M.scale/2-(t.y+t.M.p.height*t.M.scale/2)));let e=0;for(let n of canvasState.points){const{x:s,y:c,M:v,F:o,R:i,B:S,C:r,W:d,k:m}=n;if(v.o){e++,n.rotationAngle+=n.P;const v=Math.PI/18;n.rotationAngle>v?(n.rotationAngle=v,n.P*=-1):n.rotationAngle<-v&&(n.rotationAngle=-v,n.P*=-1);const o=Math.hypot(a-s,t-c);o<=100&&!m?(n.B=!0,n.k=!0):o>100&&(n.k=!1),S&&(n.R+=r*d,n.R>=10?n.C=-1:n.R<=0&&(n.R=0,n.B=!1,n.C=1))}ctx.save(),ctx.translate(s-canvasState.offsetX,c-canvasState.offsetY-(v.o?i:0)),v.o&&ctx.rotate(n.rotationAngle),o&&ctx.scale(-1,1),ctx.drawImage(v.p,-v.p.width*v.scale/2,-v.p.height*v.scale/2,v.p.width*v.scale,v.p.height*v.scale),ctx.restore()}document.getElementById("bearCount").innerText=e;for(let a of canvasState.messages){ctx.save(),ctx.globalAlpha=a.opacity,ctx.font="bold 36px Arial";const t=ctx.measureText(a.text).width;ctx.fillStyle="#FFF",ctx.fillText(a.text,a.x-canvasState.offsetX-t/2,a.y-canvasState.offsetY+a.offsetY),ctx.strokeStyle="#FFF3",ctx.lineWidth=.5,ctx.strokeText(a.text,a.x-canvasState.offsetX-t/2,a.y-canvasState.offsetY+a.offsetY),ctx.restore()}canvasState.S||(canvasState.offsetX-=canvasState.velocityX,canvasState.offsetY-=canvasState.velocityY,canvasState.velocityX*=canvasState.l,canvasState.velocityY*=canvasState.l,Math.abs(canvasState.velocityX)<.1&&(canvasState.velocityX=0),Math.abs(canvasState.velocityY)<.1&&(canvasState.velocityY=0));const n=gameFieldWidth,s=gameFieldHeight;canvasState.offsetX<0?(canvasState.offsetX=0,canvasState.velocityX=0):canvasState.offsetX>n-canvas.width&&(canvasState.offsetX=n-canvas.width,canvasState.velocityX=0),canvasState.offsetY<0?(canvasState.offsetY=0,canvasState.velocityY=0):canvasState.offsetY>s-canvas.height&&(canvasState.offsetY=s-canvas.height,canvasState.velocityY=0),requestAnimationFrame(render)}function loadSprites(a){return Promise.all(a.map((a=>new Promise(((t,e)=>{const n=new Image;n.src=a.t,n.onload=()=>t({...a,p:n}),n.onerror=e})))))}function showBearFoundMessage(a,t){const e={text:"+1 очко",x:a,y:t,opacity:1,offsetY:0};canvasState.messages.push(e);const n=()=>{if(e.offsetY-=1,e.opacity-=.01,e.opacity<=0){const a=canvasState.messages.indexOf(e);a>-1&&canvasState.messages.splice(a,1)}else requestAnimationFrame(n)};requestAnimationFrame(n)}function applyInertia(){if(!canvasState.S){canvasState.offsetX-=canvasState.velocityX,canvasState.offsetY-=canvasState.velocityY,canvasState.velocityX*=canvasState.l,canvasState.velocityY*=canvasState.l;const a=gameFieldWidth-canvas.width,t=gameFieldHeight-canvas.height;canvasState.offsetX=Math.max(0,Math.min(canvasState.offsetX,a)),canvasState.offsetY=Math.max(0,Math.min(canvasState.offsetY,t)),Math.abs(canvasState.velocityX)<.1&&(canvasState.velocityX=0),Math.abs(canvasState.velocityY)<.1&&(canvasState.velocityY=0)}requestAnimationFrame(applyInertia)}function triggerFlashEffect(){const a=document.createElement("div");a.className="flash-effect",document.body.appendChild(a),a.addEventListener("animationend",(()=>{document.body.removeChild(a)}))}function triggerRedBorderEffect(){const a=document.createElement("div");a.className="red-border",document.body.appendChild(a),a.addEventListener("animationend",(()=>{document.body.removeChild(a)}))}function checkIfAllBearsFound(){0===canvasState.points.filter((a=>a.M.o)).length&&showWinMessage()}function createModal(a,t,e){const n=document.getElementById("overlay");n.style.display="block";const s=document.createElement("div");s.className="modal",s.innerHTML=`\n        <p class="modal-text">${a}</p>\n        <button class="modal-button">${t}</button>\n    `,document.body.appendChild(s);s.querySelector(".modal-button").addEventListener("click",(()=>{document.body.removeChild(s),n.style.display="none","function"==typeof e&&e()}))}function showWelcomeMessage(){createModal("Фотографируй медведей!","Старт",(function(){}))}function showWinMessage(){createModal("Поздравляем! Вы нашли всех медведей!","Перезапустить игру",restartGame)}function restartGame(){canvasState.points=[],generatePoints()}console.log("canvasState: ",canvasState),loadSprites(sprites).then((a=>{canvasState.i=a,showWelcomeMessage(),generatePoints(),render()})),canvas.addEventListener("mousedown",(a=>{canvasState.S=!0,canvasState.m=a.clientX,canvasState.u=a.clientY,canvasState.velocityX=0,canvasState.velocityY=0})),canvas.addEventListener("mousemove",(a=>{if(canvasState.S){const t=a.clientX-canvasState.m,e=a.clientY-canvasState.u;canvasState.offsetX=Math.min(Math.max(canvasState.offsetX-t,0),gameFieldWidth-canvas.width),canvasState.offsetY=Math.min(Math.max(canvasState.offsetY-e,0),gameFieldHeight-canvas.height),canvasState.velocityX=t,canvasState.velocityY=e,canvasState.m=a.clientX,canvasState.u=a.clientY}})),canvas.addEventListener("mouseup",(()=>{canvasState.S=!1})),canvas.addEventListener("mouseleave",(()=>{canvasState.S=!1})),canvas.addEventListener("touchstart",(a=>{const t=a.touches[0];t.clientX,canvasState.offsetX,t.clientY,canvasState.offsetY;canvasState.S=!0,canvasState.m=t.clientX,canvasState.u=t.clientY,canvasState.velocityX=0,canvasState.velocityY=0})),canvas.addEventListener("touchmove",(a=>{if(!canvasState.S)return;const t=a.touches[0],e=t.clientX-canvasState.m,n=t.clientY-canvasState.u;canvasState.offsetX-=e,canvasState.offsetY-=n;const s=gameFieldWidth-canvas.width,c=gameFieldHeight-canvas.height;canvasState.offsetX=Math.max(0,Math.min(canvasState.offsetX,s)),canvasState.offsetY=Math.max(0,Math.min(canvasState.offsetY,c)),canvasState.velocityX=e,canvasState.velocityY=n,canvasState.m=t.clientX,canvasState.u=t.clientY,a.preventDefault()})),canvas.addEventListener("touchend",(()=>{canvasState.S=!1})),applyInertia(),document.getElementById("checkCenterButton").addEventListener("click",(()=>{const a=canvas.width/2+canvasState.offsetX,t=canvas.height/2+canvasState.offsetY;let e=!1;for(let n=0;n<canvasState.points.length;n++){const s=canvasState.points[n],{x:c,y:v,M:o}=s,i=o.p.width*o.scale,S=o.p.height*o.scale,r=c-i/2,d=v-S/2;if(a>=r-50&&a<=r+i+50&&t>=d-50&&t<=d+S+50&&o.o){e=!0,showBearFoundMessage(a,t),canvasState.points.splice(n,1),triggerFlashEffect();break}}e?setTimeout(checkIfAllBearsFound,300):triggerRedBorderEffect()}));